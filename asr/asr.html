<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡¶≤‡¶ø‡¶° ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶∂‡¶® ‡¶ü‡ßÅ‡¶≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Bangla:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --input-bg: #ffffff;
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-color: #667eea;
        }

        body.dark-mode {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --border-color: #444444;
            --input-bg: #3d3d3d;
        }

        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode .input-label,
        body.dark-mode span,
        body.dark-mode p {
            color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tiro Bangla', serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            background: var(--header-bg);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.5em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .settings-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .close-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tiro Bangla', serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #ee5a6f;
            transform: scale(1.05);
        }

        .settings-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #555;
            font-weight: 600;
        }

        .input-wrapper input[type="text"],
        .input-wrapper input[type="number"],
        .input-wrapper select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 8px;
            font-family: 'Tiro Bangla', serif;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .color-picker-wrapper input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            cursor: pointer;
            background: none;
        }

        .box-settings-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        /* Preview Area */
        .preview-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .card-preview {
            background: #808080;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            width: fit-content;
            margin: 0 auto;
        }

        .preview-box {
            display: flex;
            align-items: center;
            word-wrap: break-word;
            padding: 5px;
            /* Internal padding of text box */
            box-sizing: border-box;
        }

        /* Data Section */
        .data-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Tiro Bangla', serif;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-warning {
            background: #ffc107;
            color: black;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-orange {
            background: #fd7e14;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--input-bg);
            padding: 8px 15px;
            border-radius: 30px;
            border: 2px solid var(--border-color);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        /* Data Table */
        .data-table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 2px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
        }

        /* Output Section */
        .output-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .output-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .margin-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            background: var(--input-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .margin-input {
            width: 60px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
            text-align: center;
        }

        /* Paper Sheet */
        .paper-view-container {
            background: #525659;
            padding: 40px;
            border-radius: 10px;
            overflow: auto;
            display: flex;
            justify-content: center;
            min-height: 600px;
        }

        .paper-sheet {
            background: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 10px;
            /* Gap between cards on paper */
            padding: 10mm;
            /* Default, will be overridden by inline styles */
            box-sizing: border-box;
            transform-origin: top center;
        }

        .paper-sheet.A4 {
            width: 210mm;
            min-height: 297mm;
        }

        .paper-sheet.Legal {
            width: 216mm;
            min-height: 356mm;
        }

        .paper-sheet.Landscape.A4 {
            width: 297mm;
            min-height: 210mm;
        }

        .paper-sheet.Landscape.Legal {
            width: 356mm;
            min-height: 216mm;
        }

        .paper-sheet img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Hidden Render Box */
        .image-render {
            position: fixed;
            left: -9999px;
            top: 0;
            box-sizing: border-box;
        }

        .render-box {
            display: flex;
            align-items: center;
            word-wrap: break-word;
            padding: 5px;
            box-sizing: border-box;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #paperSheet,
            #paperSheet * {
                visibility: visible;
            }

            .paper-view-container {
                background: none;
                padding: 0;
                margin: 0;
                display: block;
                position: absolute;
                top: 0;
                left: 0;
            }

            #paperSheet {
                box-shadow: none;
                margin: 0;
                width: 100% !important;
                position: absolute;
                top: 0;
                left: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üöÄ ‡¶∏‡¶≤‡¶ø‡¶° ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶∂‡¶® ‡¶ü‡ßÅ‡¶≤</h1>
                <p>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶ì ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶®</p>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" title="‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®">üåì</button>
                <button class="icon-btn" onclick="toggleSettings()" title="‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="settings-modal" id="settingsModal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-warning" onclick="exportConfig()">üíæ Export</button>
                        <input type="file" id="configInput" accept=".json" onchange="importConfig(event)"
                            style="display:none">
                        <button class="btn btn-info" onclick="document.getElementById('configInput').click()">üìÇ
                            Import</button>
                        <button class="close-btn" onclick="toggleSettings()">‚úï ‡¶¨‡¶®‡ßç‡¶ß</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üÖ∞Ô∏è ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶´‡¶®‡ßç‡¶ü</h3>
                    <div class="input-group">
                        <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2"
                            onchange="handleFontUpload(event)" style="display:none">
                        <button class="btn btn-success" onclick="document.getElementById('fontFile').click()">üìÇ ‡¶´‡¶®‡ßç‡¶ü
                            ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <span id="fontStatus" style="margin-left:10px; font-size:0.9em;">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶´‡¶®‡ßç‡¶ü</span>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üé® ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶®</h3>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label class="input-label">‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°:</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="previewBgColor" onchange="updatePreviewBgColor(this.value)">
                                <span class="color-code" id="previewBgColorCode"></span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡ßç‡¶Ø‡¶æ‡¶°‡¶ø‡¶Ç (px):</label>
                            <input type="number" class="input-wrapper" id="previewPadding" value="10"
                                oninput="updatePreviewPadding(this.value)">
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>üîß ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label class="input-label">‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</label>
                            <input type="number" id="boxCount" value="3" min="1" max="10"
                                oninput="updateBoxCount(this.value)">
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ù‡ßá‡¶∞ ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ (px):</label>
                            <input type="number" id="gapSize" value="5" min="0" max="50"
                                oninput="updateGapSize(this.value)">
                        </div>
                    </div>
                </div>

                <div class="settings-section" style="background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea;">
                    <h3 style="color: #667eea;">üìè ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤</h3>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label class="input-label">‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ (cm):</label>
                            <input type="number" id="globalHeight" step="0.1" value="2.1" oninput="updateAllBoxSizes()">
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶∏‡¶ï‡¶≤ ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• (cm):</label>
                            <input type="number" id="globalWidth" step="0.1" value="15.8" oninput="updateAllBoxSizes()">
                        </div>
                    </div>
                </div>

                <div id="boxSettingsContainer"></div>

                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="toggleSettings()">‚úì ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®</button>
                </div>
            </div>
        </div>

        <div class="preview-card">
            <h3>üëÅÔ∏è ‡¶≤‡¶æ‡¶á‡¶≠ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h3>
            <div id="cardPreview" class="card-preview"></div>
        </div>

        <div class="data-section">
            <h3>üìä ‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü</h3>
            <div class="controls">
                <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)" style="display:none">
                <button class="btn btn-info" onclick="document.getElementById('csvFile').click()">üìÇ CSV ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-secondary" onclick="exportCSV()">üíæ CSV ‡¶∏‡ßá‡¶≠</button>
                <button class="btn btn-success" onclick="addRows()">‚ûï ‡¶∏‡¶æ‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó</button>
                <input type="number" id="rowActionCount" value="1" min="1"
                    style="width:60px; padding:8px; text-align:center;">
                <button class="btn btn-orange" onclick="removeRows()">‚ûñ ‡¶∏‡¶æ‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è ‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>

                <div class="toggle-wrapper" title="‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶ú ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü">
                    <span>‚ö° Auto-Preview:</span>
                    <label class="switch">
                        <input type="checkbox" id="autoGenToggle" checked onchange="toggleAutoGenerate()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="btn btn-primary" id="manualGenBtn" onclick="generateAndPopulate()"
                    style="display:none;">üîÑ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="output-section">
            <h3>üì∏ ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</h3>
            <div class="output-controls">
                <select id="paperSizeSelect" onchange="changePaperConfig()" style="padding: 10px; border-radius: 6px;">
                    <option value="A4">üìÑ A4 ‡¶∏‡¶æ‡¶á‡¶ú</option>
                    <option value="Legal">üìÑ Legal ‡¶∏‡¶æ‡¶á‡¶ú</option>
                </select>
                <select id="paperOrientationSelect" onchange="changePaperConfig()"
                    style="padding: 10px; border-radius: 6px;">
                    <option value="Portrait">‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ‡¶≤‡¶Æ‡ßç‡¶¨‡¶ø (Portrait)</option>
                    <option value="Landscape">‡¶Ü‡¶°‡¶º‡¶æ‡¶Ü‡¶°‡¶º‡¶ø (Landscape)</option>
                </select>

                <div class="margin-controls">
                    <span style="font-weight:600;">Margins (mm):</span>
                    <div title="Top"><span style="font-size:0.8em">T:</span> <input type="number" id="marginTop"
                            class="margin-input" value="10" oninput="updateMargins()"></div>
                    <div title="Bottom"><span style="font-size:0.8em">B:</span> <input type="number" id="marginBottom"
                            class="margin-input" value="10" oninput="updateMargins()"></div>
                    <div title="Left"><span style="font-size:0.8em">L:</span> <input type="number" id="marginLeft"
                            class="margin-input" value="10" oninput="updateMargins()"></div>
                    <div title="Right"><span style="font-size:0.8em">R:</span> <input type="number" id="marginRight"
                            class="margin-input" value="10" oninput="updateMargins()"></div>
                </div>

                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>‡¶á‡¶Æ‡ßá‡¶ú ‡¶∏‡ßç‡¶ï‡ßá‡¶≤ (%):</span>
                    <input type="number" id="resizePercent" value="100" min="10" max="200"
                        style="width:70px; padding:8px;" onchange="debouncedGenerate()">
                </div>

                <button class="btn btn-info" onclick="downloadIndividualImages()">‚¨áÔ∏è ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶õ‡¶¨‡¶ø (ZIP)</button>
                <button class="btn btn-success" onclick="downloadFullSheet()">‚¨áÔ∏è ‡¶™‡ßÅ‡¶∞‡ßã ‡¶™‡ßá‡¶ú (JPG)</button>
            </div>

            <div class="paper-view-container">
                <div id="paperSheet" class="paper-sheet A4">
                    <div style="width:100%; text-align:center; padding:50px; color:#666;">
                        ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ø‡¶ñ‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶Ü‡¶∏‡¶¨‡ßá...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let boxSettings = [];
        let gapSize = 5;
        let previewSettings = { bgColor: '#808080', padding: 10 };
        const PIXELS_PER_CM = 37.795275591;
        let autoGenerate = true;
        let debounceTimer;

        // --- Initialization ---
        function initializeApp() {
            loadTheme();
            loadCustomFont();
            loadSettings();
            renderBoxSettings();
            updatePreview();
            loadTableData();
            changePaperConfig();
            updateMargins();
        }

        // --- Theme & Font ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }
        function loadTheme() {
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        }

        function handleFontUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                applyCustomFont(e.target.result, file.name);
                localStorage.setItem('customFontData', e.target.result);
                localStorage.setItem('customFontName', file.name);
            };
            reader.readAsDataURL(file);
        }
        function applyCustomFont(data, name) {
            const style = document.createElement('style');
            style.textContent = `@font-face { font-family: 'CustomFont'; src: url('${data}'); } .preview-box, .render-box { font-family: 'CustomFont', 'Tiro Bangla', serif !important; }`;
            document.head.appendChild(style);
            document.getElementById('fontStatus').textContent = name;
        }
        function loadCustomFont() {
            const data = localStorage.getItem('customFontData');
            const name = localStorage.getItem('customFontName');
            if (data) applyCustomFont(data, name);
        }

        // --- Settings Management ---
        function loadSettings() {
            const savedBoxes = localStorage.getItem('boxSettings');
            const savedPreview = localStorage.getItem('previewSettings');
            const savedGap = localStorage.getItem('gapSize');

            if (savedGap) {
                gapSize = parseInt(savedGap);
                document.getElementById('gapSize').value = gapSize;
            }

            if (savedPreview) {
                previewSettings = JSON.parse(savedPreview);
                document.getElementById('previewBgColor').value = previewSettings.bgColor;
                document.getElementById('previewBgColorCode').textContent = previewSettings.bgColor;
                document.getElementById('previewPadding').value = previewSettings.padding;
            }

            if (savedBoxes) {
                boxSettings = JSON.parse(savedBoxes);
                document.getElementById('boxCount').value = boxSettings.length;
            } else {
                boxSettings = [
                    { name: 'Box 1', width: 15.8, height: 2.1, bgColor: '#FF6B86', textColor: '#000000', fontSize: 48, shape: 'rectangle', align: 'center' },
                    { name: 'Box 2', width: 15.8, height: 2.1, bgColor: '#00FF00', textColor: '#FFFFFF', fontSize: 36, shape: 'rectangle', align: 'center' },
                    { name: 'Box 3', width: 15.8, height: 2.1, bgColor: '#4A90E2', textColor: '#FFFFFF', fontSize: 36, shape: 'rectangle', align: 'center' }
                ];
            }
        }

        function saveSettings() {
            localStorage.setItem('boxSettings', JSON.stringify(boxSettings));
            localStorage.setItem('previewSettings', JSON.stringify(previewSettings));
            localStorage.setItem('gapSize', gapSize);
        }

        function updateBoxCount(val) {
            val = parseInt(val);
            while (boxSettings.length < val) {
                boxSettings.push({
                    name: `Box ${boxSettings.length + 1}`,
                    width: 15.8, height: 2.1,
                    bgColor: '#808080', textColor: '#FFFFFF', fontSize: 36, shape: 'rectangle', align: 'center'
                });
            }
            boxSettings = boxSettings.slice(0, val);
            renderBoxSettings(); updateTableHeader(); updatePreview(); saveSettings(); debouncedGenerate();
        }

        function updateGapSize(val) {
            gapSize = parseInt(val);
            updatePreview(); saveSettings(); debouncedGenerate();
        }

        function updatePreviewBgColor(val) {
            previewSettings.bgColor = val;
            document.getElementById('previewBgColorCode').textContent = val;
            updatePreview(); saveSettings(); debouncedGenerate();
        }

        function updatePreviewPadding(val) {
            previewSettings.padding = parseInt(val);
            updatePreview(); saveSettings(); debouncedGenerate();
        }

        function updateAllBoxSizes() {
            const w = parseFloat(document.getElementById('globalWidth').value);
            const h = parseFloat(document.getElementById('globalHeight').value);
            boxSettings.forEach(box => { box.width = w; box.height = h; });
            renderBoxSettings(); updatePreview(); saveSettings(); debouncedGenerate();
        }

        function renderBoxSettings() {
            const container = document.getElementById('boxSettingsContainer');
            container.innerHTML = '';
            boxSettings.forEach((box, index) => {
                const div = document.createElement('div');
                div.className = 'box-settings-card';
                div.innerHTML = `
                    <h4>üì¶ ‡¶¨‡¶ï‡ßç‡¶∏ ${index + 1}</h4>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label class="input-label">‡¶®‡¶æ‡¶Æ:</label>
                            <input type="text" value="${box.name}" oninput="updateBox(${index}, 'name', this.value)">
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú (px):</label>
                            <input type="number" value="${box.fontSize}" oninput="updateBox(${index}, 'fontSize', parseInt(this.value))">
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶â‡¶ö‡ßç‡¶ö‡¶§‡¶æ (cm):</label>
                            <input type="number" step="0.1" value="${box.height}" oninput="updateBox(${index}, 'height', parseFloat(this.value))">
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶• (cm):</label>
                            <input type="number" step="0.1" value="${box.width}" oninput="updateBox(${index}, 'width', parseFloat(this.value))">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Alignment:</label>
                            <select onchange="updateBox(${index}, 'align', this.value)">
                                <option value="left" ${box.align === 'left' ? 'selected' : ''}>Left</option>
                                <option value="center" ${box.align === 'center' || !box.align ? 'selected' : ''}>Center</option>
                                <option value="right" ${box.align === 'right' ? 'selected' : ''}>Right</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">‡¶Ü‡¶ï‡¶æ‡¶∞:</label>
                            <select onchange="updateBox(${index}, 'shape', this.value)">
                                <option value="rectangle" ${box.shape === 'rectangle' ? 'selected' : ''}>Rectangle</option>
                                <option value="square" ${box.shape === 'square' ? 'selected' : ''}>Square</option>
                                <option value="circle" ${box.shape === 'circle' ? 'selected' : ''}>Circle</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-grid">
                        <div class="color-picker-wrapper">
                            <label>BG:</label>
                            <input type="color" value="${box.bgColor}" onchange="updateBox(${index}, 'bgColor', this.value)">
                        </div>
                        <div class="color-picker-wrapper">
                            <label>Text:</label>
                            <input type="color" value="${box.textColor}" onchange="updateBox(${index}, 'textColor', this.value)">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateBox(index, prop, val) {
            boxSettings[index][prop] = val;
            if (prop === 'name') updateTableHeader();
            updatePreview(); saveSettings(); debouncedGenerate();
        }

        // --- Preview Logic ---
        function updatePreview() {
            const preview = document.getElementById('cardPreview');
            preview.innerHTML = '';
            preview.style.backgroundColor = previewSettings.bgColor;
            preview.style.padding = `${previewSettings.padding}px`;

            // Use first row data or default
            const firstRowInputs = document.querySelectorAll('#tableBody tr:first-child input');
            const data = firstRowInputs.length > 0 ? Array.from(firstRowInputs).map(i => i.value) : [];

            boxSettings.forEach((box, i) => {
                const div = document.createElement('div');
                div.className = 'preview-box';
                div.textContent = data[i] || box.name;
                div.style.backgroundColor = box.bgColor;
                div.style.color = box.textColor;
                div.style.fontSize = `${box.fontSize}px`;
                div.style.width = `${box.width * PIXELS_PER_CM}px`;
                div.style.minHeight = `${box.height * PIXELS_PER_CM}px`;
                div.style.borderRadius = box.shape === 'circle' ? '50%' : '0';
                div.style.justifyContent = box.align === 'left' ? 'flex-start' : (box.align === 'right' ? 'flex-end' : 'center');
                div.style.textAlign = box.align || 'center';

                // Gap implementation
                if (i < boxSettings.length - 1) {
                    div.style.marginBottom = `${gapSize}px`;
                }
                preview.appendChild(div);
            });
        }

        // --- Data Handling & Auto-Generation ---
        function toggleAutoGenerate() {
            autoGenerate = document.getElementById('autoGenToggle').checked;
            document.getElementById('manualGenBtn').style.display = autoGenerate ? 'none' : 'inline-block';
            if (autoGenerate) debouncedGenerate();
        }

        // Debounce Function
        function debouncedGenerate() {
            if (!autoGenerate) return;
            clearTimeout(debounceTimer);
            // Show loading state
            const sheet = document.getElementById('paperSheet');
            if (!sheet.innerHTML.includes('Processing')) {
                // Optional: visual cue
            }
            debounceTimer = setTimeout(() => {
                generateAndPopulate();
            }, 1500); // 1.5 seconds delay
        }

        function createRow(index, data = []) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="font-weight:bold; color:var(--accent-color)">${index}</td>`;
            boxSettings.forEach((_, i) => {
                const td = document.createElement('td');
                const input = document.createElement('input');
                input.type = 'text';
                input.value = data[i] || '';
                input.oninput = () => {
                    saveTableData();
                    if (index === 1) updatePreview(); // Update preview card immediately
                    debouncedGenerate();
                };
                td.appendChild(input);
                tr.appendChild(td);
            });
            document.getElementById('tableBody').appendChild(tr);
        }

        function addRows() {
            const count = parseInt(document.getElementById('rowActionCount').value) || 1;
            const currentRows = document.getElementById('tableBody').children.length;
            for (let i = 0; i < count; i++) createRow(currentRows + i + 1);
            saveTableData();
        }

        function removeRows() {
            const body = document.getElementById('tableBody');
            const count = parseInt(document.getElementById('rowActionCount').value) || 1;
            for (let i = 0; i < count; i++) {
                if (body.lastChild) body.removeChild(body.lastChild);
            }
            saveTableData(); debouncedGenerate();
        }

        function clearAllData() {
            if (confirm('‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                document.getElementById('tableBody').innerHTML = '';
                saveTableData();
                updatePreview();
                document.getElementById('paperSheet').innerHTML = '';
            }
        }

        function updateTableHeader() {
            const tr = document.getElementById('tableHeader');
            tr.innerHTML = '<th>#</th>';
            boxSettings.forEach(b => {
                const th = document.createElement('th');
                th.textContent = b.name;
                tr.appendChild(th);
            });
        }

        function saveTableData() {
            const data = [];
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('input').forEach(i => row.push(i.value));
                data.push(row);
            });
            localStorage.setItem('tableData', JSON.stringify(data));
        }

        function loadTableData() {
            const saved = localStorage.getItem('tableData');
            const data = saved ? JSON.parse(saved) : [];
            document.getElementById('tableBody').innerHTML = '';
            updateTableHeader();
            if (data.length) data.forEach((r, i) => createRow(i + 1, r));
            else { for (let i = 0; i < 3; i++) createRow(i + 1); }
            generateAndPopulate();
        }

        // --- Output Generation Logic ---
        async function generateAndPopulate() {
            const sheet = document.getElementById('paperSheet');
            const dataRows = [];

            // Collect data
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                const inputs = Array.from(tr.querySelectorAll('input')).map(i => i.value.trim());
                if (inputs.some(val => val !== '')) dataRows.push(inputs); // Skip empty rows
            });

            if (dataRows.length === 0) {
                sheet.innerHTML = '<div style="width:100%; text-align:center; padding:50px; color:#666;">‡¶ü‡ßá‡¶¨‡¶ø‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...</div>';
                return;
            }

            sheet.innerHTML = '<div style="width:100%; text-align:center; padding:50px;">‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‚è≥</div>';

            const resizePercent = parseInt(document.getElementById('resizePercent').value) || 100;
            const tempContainer = document.createElement('div'); // Container for generated images

            // Calculate max width
            let maxW = 0;
            boxSettings.forEach(b => maxW = Math.max(maxW, b.width * PIXELS_PER_CM));
            const finalW = maxW + (previewSettings.padding * 2);

            // Generate images one by one
            const imagesFragment = document.createDocumentFragment();

            for (let i = 0; i < dataRows.length; i++) {
                const rowData = dataRows[i];

                // DOM Node for HTML2Canvas
                const node = document.createElement('div');
                node.className = 'image-render';
                node.style.width = finalW + 'px';
                node.style.backgroundColor = previewSettings.bgColor;
                node.style.padding = previewSettings.padding + 'px';
                node.style.display = 'flex';
                node.style.flexDirection = 'column';

                boxSettings.forEach((box, idx) => {
                    const boxDiv = document.createElement('div');
                    boxDiv.className = 'render-box';
                    boxDiv.textContent = rowData[idx] || '';
                    boxDiv.style.backgroundColor = box.bgColor;
                    boxDiv.style.color = box.textColor;
                    boxDiv.style.fontSize = box.fontSize + 'px';
                    boxDiv.style.width = (box.width * PIXELS_PER_CM) + 'px';
                    boxDiv.style.minHeight = (box.height * PIXELS_PER_CM) + 'px';
                    boxDiv.style.borderRadius = box.shape === 'circle' ? '50%' : '0';
                    boxDiv.style.justifyContent = box.align === 'left' ? 'flex-start' : (box.align === 'right' ? 'flex-end' : 'center');
                    boxDiv.style.textAlign = box.align || 'center';
                    boxDiv.style.margin = '0 auto'; // Center in card

                    // Gap
                    if (idx < boxSettings.length - 1) {
                        boxDiv.style.marginBottom = gapSize + 'px';
                    }
                    node.appendChild(boxDiv);
                });

                document.body.appendChild(node);

                try {
                    const canvas = await html2canvas(node, {
                        scale: 2, // High resolution
                        backgroundColor: null,
                        logging: false
                    });

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg', 0.9);
                    img.style.width = (finalW * (resizePercent / 100)) + 'px';
                    img.title = `Row ${i + 1}`;
                    imagesFragment.appendChild(img);
                } catch (e) {
                    console.error(e);
                }
                document.body.removeChild(node);
            }

            sheet.innerHTML = '';
            sheet.appendChild(imagesFragment);
        }

        // --- Paper & Downloads ---
        function changePaperConfig() {
            const size = document.getElementById('paperSizeSelect').value;
            const orient = document.getElementById('paperOrientationSelect').value;
            document.getElementById('paperSheet').className = `paper-sheet ${size} ${orient}`;
        }

        function updateMargins() {
            const t = document.getElementById('marginTop').value || 0;
            const b = document.getElementById('marginBottom').value || 0;
            const l = document.getElementById('marginLeft').value || 0;
            const r = document.getElementById('marginRight').value || 0;
            document.getElementById('paperSheet').style.padding = `${t}mm ${r}mm ${b}mm ${l}mm`;
        }

        function downloadFullSheet() {
            const sheet = document.getElementById('paperSheet');
            if (sheet.querySelectorAll('img').length === 0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶Æ‡ßá‡¶ú ‡¶®‡ßá‡¶á!');

            html2canvas(sheet, { scale: 2 }).then(canvas => {
                saveAs(canvas.toBlob(), 'full_sheet.jpg');
            });
        }

        function downloadIndividualImages() {
            const imgs = document.querySelectorAll('#paperSheet img');
            if (imgs.length === 0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶Æ‡ßá‡¶ú ‡¶®‡ßá‡¶á!');

            const zip = new JSZip();
            imgs.forEach((img, i) => {
                zip.file(`card_${i + 1}.jpg`, img.src.split(',')[1], { base64: true });
            });
            zip.generateAsync({ type: "blob" }).then(content => saveAs(content, "cards.zip"));
        }

        // --- Import/Export ---
        function exportConfig() {
            const cfg = { boxSettings, previewSettings, gapSize };
            saveAs(new Blob([JSON.stringify(cfg)], { type: "application/json" }), "config.json");
        }
        function importConfig(e) {
            const file = e.target.files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const c = JSON.parse(ev.target.result);
                if (c.boxSettings) boxSettings = c.boxSettings;
                if (c.previewSettings) previewSettings = c.previewSettings;
                if (c.gapSize) gapSize = c.gapSize;
                saveSettings(); location.reload();
            };
            r.readAsText(file);
        }
        function importCSV(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const rows = ev.target.result.split('\n').map(r => r.split(','));
                document.getElementById('tableBody').innerHTML = '';
                rows.forEach((r, i) => { if (r.join('').trim()) createRow(i + 1, r); });
                saveTableData(); debouncedGenerate();
            };
            reader.readAsText(file);
        }
        function exportCSV() {
            const csv = localStorage.getItem('tableData') ? JSON.parse(localStorage.getItem('tableData')).map(r => r.join(',')).join('\n') : '';
            saveAs(new Blob([csv], { type: 'text/csv' }), 'data.csv');
        }

        // Settings toggle
        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('active');
        }

        initializeApp();
    </script>

    <script>
        document.addEventListener('keydown', function (event) {
            // 'Escape' ‡¶¨‡¶æ 'Esc' ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            if (event.key === "Escape") {
                // ‡¶è‡¶á ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶¨‡ßá
                window.location.href = "../aio.html";
            }
        });
    </script>

</body>

</html>